{% load static %}
<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <!-- Основные стили -->
  <link rel="stylesheet" href="{% static 'users/css/main.css' %}">
  <link rel="stylesheet" href="{% static 'users/css/profile.css' %}">

  <script src="{% static 'users/js/profile.js' %}"></script>
  <script src="{% static 'users/js/background.js' %}"></script>

  <title>Profile & API Keys</title>
</head>
<body>
  <!-- Canvas background -->
  <canvas id="network-canvas"></canvas>

  <!-- NAV-->
  <nav class="navbar">
    <div class="nav-actions">
      <a href="{% url 'interface:dashboard' %}" class="nav-link">Дашборд</a>
      <a href="#" class="nav-link active">Профиль / API</a>
      <a class="nav-link logout-link" href="{% url 'users:logout' %}">Выйти</a>
    </div>
  </nav>

  <main class="main">
    <!--  Левая панель - профиль -->
    <section class="sidebar">
      <h2 class="section-title">Профиль</h2>
      <form class="form" method="post">
        {% csrf_token %}
        <div class="form-group">
          <label for="username">Имя</label>
          <input type="text" id="username" name="full_name" value="{{ user.get_full_name|default:user.username }}">
        </div>

        <div class="form-group">
          <label>Email-адреса</label>
          <div class="email-list">
            <div class="email-badge">
              {{ user.email }} (Primary)
              <button type="button" class="remove-btn">&#10005;</button>
            </div>
          </div>
          <div class="email-actions">
            <button type="button" class="btn-link" id="addEmailBtn">+ Добавить Email</button>
          </div>
        </div>

        <div class="form-group">
          <label>Пароль</label>
          <input type="password" value="••••••••" disabled>
          <div><button type="button" class="btn-link" id="changePasswordBtn">Сменить пароль</button></div>
        </div>

        <div class="form-actions">
          <button type="submit" class="btn-primary">Сохранить изменения</button>
        </div>
      </form>
    </section>

    <!-- Правая часть - API ключи -->
    <section class="content">
      <h2 class="section-title">API Ключи</h2>
      <div class="card">
        <div class="card-header">
          <span class="text-muted">Ваши ключи</span>
          <button class="btn-primary" id="openModalBtn">+ Создать ключ</button>
        </div>
        <div class="table-container">
          <!-- Таблица -->
          <table class="table" id="devicesTable">
            <thead>
              <tr>
                <th>Название</th>
                <th class="text-center">API Ключ</th>
                <th class="text-center">Дата создания</th>
                <th class="text-center">APK</th>
                <th class="delete-column"></th>
              </tr>
            </thead>
            <tbody>
              <!-- Api ключи -->
              {% for device in devices %}
              <tr data-status="">
                  <td>{{ device.name }}</td>
                <td>
                  <p class="mono text-center">{{ device.api_key.key }}</p>
                </td>
                <td class="text-center">{{ device.api_key.created_at|date:"Y-m-d" }}</td>
                <td class="text-center">
                  <button class="apk-btn btn-primary" data-status="order" data-device-id="{{ device.id }}">
                    Собрать APK
                  </button>
                </td>
                <td class="delete-column">
                  <button class="remove-btn delete-btn" title="Delete" onclick="deleteDevice('{{ device.id }}', '{{ device.name }}')">
                    &#10005;
                  </button>
                </td>
              </tr>
              {% empty %}
              <tr>
                <td colspan="5" class="text-center text-muted">Нет созданных API ключей</td>
              </tr>
              {% endfor %}
            </tbody>
          </table>
        </div>
      </div>
    </section>
  </main>

  <!-- Скрипты -->
  <script>
        // Функция для копирования API ключа
        function copyApiKey(key) {
            navigator.clipboard.writeText(key)
                .then(() => {
                    alert('API key copied to clipboard!');
                })
                .catch(err => {
                    console.error('Failed to copy: ', err);
                    alert('Failed to copy API key');
                });
        }

        // Функция для удаления устройства
        function deleteDevice(deviceId, deviceName) {
            if (confirm(`Are you sure you want to delete the device "${deviceName}"?`)) {
                fetch(`/api/api-key/${deviceId}/`, {
                    method: 'DELETE',
                    headers: {
                        'X-CSRFToken': getCookie('csrftoken')
                    }
                })
                .then(response => {
                    if (response.ok) {
                        alert('Device deleted successfully!');
                        location.reload();
                    } else {
                        throw new Error('Failed to delete device');
                    }
                })
                .catch(error => {
                    console.error('Error:', error);
                    alert('Error deleting device');
                });
            }
        }

        // Вспомогательная функция для получения CSRF токена
        function getCookie(name) {
            let cookieValue = null;
            if (document.cookie && document.cookie !== '') {
                const cookies = document.cookie.split(';');
                for (let i = 0; i < cookies.length; i++) {
                    const cookie = cookies[i].trim();
                    if (cookie.substring(0, name.length + 1) === (name + '=')) {
                        cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                        break;
                    }
                }
            }
            return cookieValue;
        }

        document.addEventListener('DOMContentLoaded', function() {
            // Обработчик для кнопки "New Key"
            const openModalBtn = document.getElementById('openModalBtn');

            if (openModalBtn) {
                openModalBtn.addEventListener('click', function() {
                    // Используем prompt для ввода названия ключа
                    const keyName = prompt('Enter a name for your new API key:', 'My API Key');

                    // Если пользователь не отменил ввод и ввел не пустую строку
                    if (keyName !== null && keyName.trim() !== '') {
                        // Здесь можно отправить запрос на сервер для создания ключа
                        createApiKey(keyName.trim());
                    } else if (keyName !== null) {
                        // Если введена пустая строка
                        alert('Please enter a valid name for the API key.');
                    }
                });
            }

            // Функция для создания API ключа
            function createApiKey(name) {
                console.log('Creating API key with name:', name);

                // Отправляем POST запрос на сервер
                fetch('/api/api-key/', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'X-CSRFToken': getCookie('csrftoken')
                    },
                    body: JSON.stringify({ name: name })
                })
                .then(response => {
                    if (!response.ok) {
                        return response.json().then(errorData => {
                            throw new Error(errorData.error || 'Network response was not ok');
                        });
                    }
                    return response.json();
                })
                .then(data => {
                    // Показываем пользователю созданный API ключ
                    alert(`API key created successfully!\n\nDevice: ${data.device_name}\nAPI Key: ${data.api_key}\n\nPlease save this key - it won't be shown again!`);
                    addNewDeviceRow(data.device_name, data.api_key, data.device_id);
                })
                .catch(error => {
                    console.error('Error:', error);
                    alert('Error: ' + error.message);
                });
            }

            function addNewDeviceRow(deviceName, apiKey, deviceId) {
                const tbody = document.querySelector('#devicesTable tbody');

                // Убираем "Нет созданных API ключей"
                if (tbody.querySelector('td[colspan]')) {
                    tbody.innerHTML = '';
                }

                // Создаем элементы вручную
                const tr = document.createElement('tr');

                // Название устройства
                const tdName = document.createElement('td');
                tdName.textContent = deviceName;

                // API ключ
                const tdKey = document.createElement('td');
                const pKey = document.createElement('p');
                pKey.className = 'mono text-center';
                pKey.textContent = apiKey;
                tdKey.appendChild(pKey);

                // Дата создания
                const tdDate = document.createElement('td');
                tdDate.className = 'text-center';
                tdDate.textContent = new Date().toISOString().split('T')[0];

                // Кнопка APK
                const tdApk = document.createElement('td');
                tdApk.className = 'text-center';
                const apkBtn = document.createElement('button');
                apkBtn.className = 'apk-btn btn-primary';
                apkBtn.textContent = 'Собрать APK';
                apkBtn.dataset.deviceId = deviceId;
                tdApk.appendChild(apkBtn);

                // Кнопка удаления
                const tdDelete = document.createElement('td');
                tdDelete.className = 'delete-column';
                const deleteBtn = document.createElement('button');
                deleteBtn.className = 'remove-btn delete-btn';
                deleteBtn.innerHTML = '&#10005;';
                deleteBtn.onclick = function() { deleteDevice(deviceId, deviceName); };
                tdDelete.appendChild(deleteBtn);

                // Собираем строку
                tr.appendChild(tdName);
                tr.appendChild(tdKey);
                tr.appendChild(tdDate);
                tr.appendChild(tdApk);
                tr.appendChild(tdDelete);

                // Добавляем в таблицу
                tbody.appendChild(tr);

                const statuses = {order: "order", create: "create", ready: "ready"};
                // Добавляем обработчик для кнопки APK
                apkBtn.addEventListener('click', function() {
                    let status = apkBtn.getAttribute("data-status");
                    let row = apkBtn.closest("tr");
                    if (status == statuses.order) {
                        apkBtn.textContent = "На сборке";
                        apkBtn.setAttribute("data-status", statuses.create);
                        row.setAttribute("data-status", statuses.create);
                        // Отправить запрос на сервер
                    } else if (status == statuses.create){
                        // Отправить запрос на сервер
                        const response = 1;
                        if (response) {
                            apkBtn.textContent = "Скачать APK";
                            apkBtn.setAttribute("data-status", statuses.ready);
                            row.setAttribute("data-status", statuses.ready);
                        }
                    }
                });

                // Делаем API ключ копируемым
                pKey.style.cursor = 'pointer';
                pKey.addEventListener('click', function() {
                    navigator.clipboard.writeText(apiKey)
                        .then(() => {
                            const original = this.textContent;
                            this.textContent = 'Скопировано!';
                            const key = this.textContent.trim();
                            navigator.clipboard.writeText(original).then(() => {
                              this.classList.add("copied");
                              setTimeout(() => this.classList.remove("copied"), 1500);
                              setTimeout(() => this.textContent = original, 1500);
                            });
                        });
                });
            }
        });
    </script>
</body>
</html>