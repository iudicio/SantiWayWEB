# Nginx Reverse Proxy
# Проксирует запросы на Django, отдаёт статику
apiVersion: apps/v1
kind: Deployment
metadata:
  name: nginx
  namespace: santiway
  labels:
    app: nginx
    component: frontend
spec:
  replicas: 2
  selector:
    matchLabels:
      app: nginx
  template:
    metadata:
      labels:
        app: nginx
    spec:
      containers:
        - name: nginx
          image: nginx:1.27-alpine
          ports:
            - containerPort: 80
              name: http
          
          # Liveness Probe
          livenessProbe:
            httpGet:
              path: /nginx-health
              port: http
            initialDelaySeconds: 5
            periodSeconds: 10
            timeoutSeconds: 3
            failureThreshold: 3
          
          # Readiness Probe
          readinessProbe:
            httpGet:
              path: /nginx-health
              port: http
            initialDelaySeconds: 3
            periodSeconds: 5
            timeoutSeconds: 2
            failureThreshold: 3
          
          resources:
            requests:
              memory: "64Mi"
              cpu: "50m"
            limits:
              memory: "128Mi"
              cpu: "200m"
          
          volumeMounts:
            - name: nginx-config
              mountPath: /etc/nginx/nginx.conf
              subPath: nginx.conf
              readOnly: true
            - name: static
              mountPath: /var/www/static
              readOnly: true
            - name: media
              mountPath: /var/www/media
              readOnly: true
      
      volumes:
        - name: nginx-config
          configMap:
            name: nginx-config
        - name: static
          persistentVolumeClaim:
            claimName: static-pvc
        - name: media
          persistentVolumeClaim:
            claimName: media-pvc

---
apiVersion: v1
kind: Service
metadata:
  name: nginx
  namespace: santiway
spec:
  type: LoadBalancer  # Или NodePort для локального кластера
  selector:
    app: nginx
  ports:
    - port: 80
      targetPort: http
      name: http

---
# ConfigMap с nginx.conf
apiVersion: v1
kind: ConfigMap
metadata:
  name: nginx-config
  namespace: santiway
data:
  nginx.conf: |
    user  nginx;
    worker_processes  auto;

    error_log  /var/log/nginx/error.log warn;
    pid        /var/run/nginx.pid;

    events { worker_connections 1024; }

    http {
      include       /etc/nginx/mime.types;
      default_type  application/octet-stream;
      sendfile      on;
      keepalive_timeout  65;

      # Логи в формате JSON для парсинга
      log_format json_combined escape=json '{'
        '"time":"$time_iso8601",'
        '"remote_addr":"$remote_addr",'
        '"request":"$request",'
        '"status":$status,'
        '"body_bytes_sent":$body_bytes_sent,'
        '"request_time":$request_time,'
        '"upstream_response_time":"$upstream_response_time",'
        '"http_user_agent":"$http_user_agent"'
      '}';
      access_log /var/log/nginx/access.log json_combined;

      upstream django_upstream {
        server web:8000;
        keepalive 32;
      }

      server {
        listen 80;
        server_name _;

        client_max_body_size 64m;

        # Статика/медиа из общих томов
        location /static/ {
          alias /var/www/static/;
          access_log off;
          expires 30d;
        }

        location /media/ {
          alias /var/www/media/;
          access_log off;
          expires 30d;
        }

        location / {
          proxy_set_header Host $host;
          proxy_set_header X-Real-IP $remote_addr;
          proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
          proxy_set_header X-Forwarded-Proto $scheme;
          proxy_set_header Cookie $http_cookie;
          proxy_redirect off;
          proxy_pass http://django_upstream;
        }

        location = /nginx-health { 
          return 200 'ok'; 
          add_header Content-Type text/plain; 
        }
      }
    }

